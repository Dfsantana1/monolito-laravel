_format_version: "3.0"

services:
  # User Service
  - name: user-service
    url: http://user-service:8001
    routes:
      - name: user-routes
        strip_path: true
        paths:
          - /api/users
          - /api/auth
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000

  # Product Service
  - name: product-service
    url: http://product-service:8002
    routes:
      - name: product-routes
        strip_path: true
        paths:
          - /api/products
          - /api/categories
    plugins:
      - name: rate-limiting
        config:
          minute: 200
          hour: 2000

  # Cart Service
  - name: cart-service
    url: http://cart-service:8003
    routes:
      - name: cart-routes
        strip_path: true
        paths:
          - /api/cart
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
      - name: rate-limiting
        config:
          minute: 150
          hour: 1500

  # Order Service
  - name: order-service
    url: http://order-service:8004
    routes:
      - name: order-routes
        strip_path: true
        paths:
          - /api/orders
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
      - name: rate-limiting
        config:
          minute: 50
          hour: 500

  # Payment Service
  - name: payment-service
    url: http://payment-service:8005
    routes:
      - name: payment-routes
        strip_path: true
        paths:
          - /api/payments
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
      - name: rate-limiting
        config:
          minute: 30
          hour: 300

  # Notification Service
  - name: notification-service
    url: http://notification-service:8006
    routes:
      - name: notification-routes
        strip_path: true
        paths:
          - /api/notifications
    plugins:
      - name: jwt
        config:
          secret_is_base64: false
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000

# Global plugins
plugins:
  - name: cors
    config:
      origins:
        - "http://localhost:3000"
        - "http://frontend:3000"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - X-Auth-Token
        - Authorization
      exposed_headers:
        - X-Auth-Token
      credentials: true
      max_age: 3600

  - name: request-transformer
    config:
      add:
        headers:
          - "X-Forwarded-For:$(proxy_protocol_addr)"
          - "X-Forwarded-Proto:$(proxy_protocol_scheme)"

consumers:
  - username: api-consumer
    jwt_secrets:
      - key: "your-jwt-secret-key"
        algorithm: "HS256"
